<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Ved Notetaker Widget</title>
  <style>
    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      background: transparent !important;
      overflow: hidden;
      box-sizing: border-box;
    }
    body {
      position: relative;
      background: transparent !important;
      width: 100vw;
      height: 100vh;
    }
    #ball, #widget {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      user-select: none;
      box-sizing: border-box;
    }
    #ball {
      background: radial-gradient(ellipse at 60% 35%, #60aaff 80%, #2566d8 100%);
      border-radius: 50%;
      width: 100%;
      height: 100%;
      box-shadow:
        0 2px 18px 4px rgba(44, 103, 255, 0.17),
        0 0 0 2px rgba(0,0,0,0.03);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2;
      transition: box-shadow 0.2s;
      cursor: grab;
      position: relative;
      overflow: visible;
    }
    #ball:after {
      content: '';
      position: absolute;
      top: 9%; left: 20%;
      width: 60%; height: 33%;
      background: linear-gradient(120deg, rgba(255,255,255,0.5) 0%, rgba(255,255,255,0.10) 100%);
      border-radius: 70% 70% 45% 45%/ 60% 60% 35% 35%;
      pointer-events: none;
      z-index: 3;
      filter: blur(0.5px);
    }
    #ball-icon {
      font-size: 32px;
      color: #fff;
      pointer-events: none;
      user-select: none;
      z-index: 2;
      text-shadow: 0 1px 6px rgba(20,50,160,0.15);
    }
    #close-ball {
      position: absolute;
      top: -11px;
      right: -11px;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: #fff;
      color: #2b7cff;
      border: 1.5px solid #2b7cff;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      line-height: 24px;
      cursor: pointer;
      z-index: 5;
      display: none;
      box-shadow: 0 2px 6px rgba(44,103,255,0.16);
      transition: background 0.2s, color 0.2s;
    }
    #ball:hover #close-ball { display: block; }
    #close-ball:hover { background: #2b7cff; color: #fff; }

    #widget {
      background: rgba(255,255,255,0.97);
      border-radius: 24px;
      box-shadow: 0 2px 16px rgba(44,103,255,0.16);
      display: flex;
      flex-direction: row;
      align-items: flex-end;
      padding: 10px 44px 10px 16px;
      gap: 8px;
      z-index: 10;
      height: 100%;
      width: 100%;
      transition: all 0.2s;
      overflow: visible;
      cursor: grab;
      position: relative;
      box-sizing: border-box;
    }
    #widget-content {
      display: flex;
      flex: 1;
      align-items: flex-end;
      gap: 8px;
      cursor: auto;
      box-sizing: border-box;
    }
    #note-input {
      flex: 1;
      font-size: 1rem;
      border: 1px solid #ddd;
      border-radius: 16px;
      outline: none;
      min-height: 28px;
      max-height: 120px;
      padding: 7px 10px;
      resize: none;
      overflow-y: auto;
      box-sizing: border-box;
      min-width: 0;
      line-height: 1.4;
      background: #fff;
      transition: border-color 0.2s, max-height 0.2s;
    }
    #widget.textarea-expanded #note-input {
      min-height: 90px;
      max-height: 260px;
      font-size: 1.07rem;
      padding: 12px 10px;
    }
    .button-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      gap: 2px;
      margin-left: 2px;
      height: 68px;
      min-width: 36px;
    }
    #expand-btn {
      background: #f4f6fd;
      color: #2b7cff;
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      min-width: 28px;
      min-height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      cursor: pointer;
      margin-bottom: 2px;
      box-shadow: none;
      transition: background 0.18s;
    }
    #expand-btn.active {
      background: #d9e6fd;
      color: #195bcb;
    }
    #expand-btn:hover {
      background: #e1e9fd;
      color: #195bcb;
    }
    #send-btn {
      background: #2b7cff;
      color: white;
      border: none;
      border-radius: 50%;
      width: 34px;
      height: 34px;
      min-width: 34px;
      min-height: 34px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 19px;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 0 1px 6px rgba(44,103,255,0.10);
    }
    #send-btn:hover { background: #195bcb; }
    #send-btn .icon { margin: 0; font-size: 18px; }
    #status {
      font-size: 0.85rem;
      color: #888;
      margin-left: 8px;
      align-self: flex-end;
    }
    #close-widget {
      position: absolute;
      top: -11px;
      right: -11px;
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: #fff;
      color: #2b7cff;
      border: 1.5px solid #2b7cff;
      font-size: 18px;
      font-weight: bold;
      text-align: center;
      line-height: 24px;
      cursor: pointer;
      z-index: 20;
      display: none;
      box-shadow: 0 2px 6px rgba(44,103,255,0.16);
      transition: background 0.2s, color 0.2s;
    }
    #widget:hover #close-widget { display: block; }
    #close-widget:hover { background: #2b7cff; color: #fff; }
  </style>
</head>
<body>
  <div id="ball" style="display: none;">
    <span id="ball-icon">üìù</span>
    <span id="close-ball">&times;</span>
  </div>
  <form id="widget" style="display: none;">
    <div id="widget-content">
      <textarea id="note-input" rows="1" placeholder="Jot down a thought..."></textarea>
      <div class="button-group">
        <button type="button" id="expand-btn" title="Expand textarea">&#x2922;</button>
        <button type="submit" id="send-btn" title="Send">
          <span class="icon">&#8594;</span>
        </button>
      </div>
      <div id="status"></div>
    </div>
    <span id="close-widget">&times;</span>
  </form>
  <script>
    let isExpanded = true;
    const BALL_SIZE = 60,
      WIDGET_WIDTH = 360,
      WIDGET_HEIGHT = 70,
      WIDGET_HEIGHT_EXPANDED = 220,
      BOTTOM_MARGIN = 16,
      SIDE_MARGIN = 16,
      USER_ID = '7dcb16b8-c05c-4ec4-9524-0003e11acd2a';

    const ball = document.getElementById('ball');
    const widget = document.getElementById('widget');
    const noteInput = document.getElementById('note-input');
    const status = document.getElementById('status');
    const closeBall = document.getElementById('close-ball');
    const closeWidget = document.getElementById('close-widget');
    const expandBtn = document.getElementById('expand-btn');
    const sendBtn = document.getElementById('send-btn');

    // 1. Expand button logic (also change window height)
    expandBtn.onclick = () => {
      const expanded = widget.classList.toggle('textarea-expanded');
      expandBtn.classList.toggle('active');
      noteInput.focus();
      noteInput.dispatchEvent(new Event('input'));
      // Change window height in Electron
      let x = window.screenX, y = window.screenY;
      let { w, h } = { w: window.screen.width, h: window.screen.height };
      let width = WIDGET_WIDTH;
      let height = expanded ? WIDGET_HEIGHT_EXPANDED : WIDGET_HEIGHT;
      if (x + width + SIDE_MARGIN > w) x = w - width - SIDE_MARGIN;
      if (y + height + BOTTOM_MARGIN > h) y = h - height - BOTTOM_MARGIN;
      window.electronAPI.setWindow({ width, height, x, y });
    };

    // Auto-expand textarea vertically
    noteInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });

    // Pressing Enter submits, Shift+Enter inserts new line
    noteInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendBtn.click();
      }
    });

    // Ball drag shape fix
    let dragging = false, dragStart = {x: 0, y: 0}, winStart = {x: 0, y: 0};
    function getScreenBounds() {
      return { w: window.screen.width, h: window.screen.height };
    }
    function clamp(val, min, max) { return Math.max(min, Math.min(val, max)); }
    function setWindow(width, height, x, y) {
      window.electronAPI.setWindow({ width, height, x, y });
    }
    function enableDrag(element, mode) {
      element.addEventListener('mousedown', e => {
        if (e.target.closest('textarea,button,#note-input,#send-btn,#expand-btn')) return;
        dragging = true;
        dragStart = { x: e.screenX, y: e.screenY };
        winStart = { x: window.screenX, y: window.screenY };
        document.body.style.cursor = 'grabbing';
      });
      window.addEventListener('mousemove', e => {
        if (!dragging) return;
        let dx = e.screenX - dragStart.x;
        let dy = e.screenY - dragStart.y;
        let { w, h } = getScreenBounds();
        let width = (mode === "ball") ? BALL_SIZE : WIDGET_WIDTH;
        let height;
        if (mode === "ball") height = BALL_SIZE;
        else if (widget.classList.contains('textarea-expanded')) height = WIDGET_HEIGHT_EXPANDED;
        else height = WIDGET_HEIGHT;
        let newX = clamp(winStart.x + dx, SIDE_MARGIN, w - width - SIDE_MARGIN);
        let newY = clamp(winStart.y + dy, BOTTOM_MARGIN, h - height - BOTTOM_MARGIN);
        setWindow(width, height, newX, newY);
      });
      window.addEventListener('mouseup', () => {
        if (dragging) document.body.style.cursor = '';
        dragging = false;
      });
    }
    enableDrag(ball, "ball");
    enableDrag(widget, "widget");

    // Submit logic
    widget.addEventListener('submit', async (e) => {
      e.preventDefault();
      const content = noteInput.value.trim();
      if (!content) return;
      status.textContent = 'Sending...';
      try {
        const resp = await fetch('http://localhost:8000/v1/ingest', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({
            user_id: USER_ID,
            data_source: "user_typed",
            content: content
          })
        });
        if (!resp.ok) throw new Error('Failed: ' + resp.status);
        status.textContent = 'Note sent!';
        noteInput.value = '';
        noteInput.style.height = '28px';
      } catch (err) {
        status.textContent = 'Error: ' + err.message;
      }
      setTimeout(() => status.textContent = '', 1200);
    });

    closeBall.onclick = closeWidget.onclick = () => window.electronAPI.closeWindow();

    // Smooth snap animation for ball
    function animateToDefaultBallPosition() {
      const { w, h } = getScreenBounds();
      const destX = w - BALL_SIZE - SIDE_MARGIN;
      const destY = h - BALL_SIZE - BOTTOM_MARGIN;
      const startX = window.screenX;
      const startY = window.screenY;
      const steps = 18;
      let step = 0;
      function animate() {
        step++;
        const t = step / steps;
        const ease = t < 1 ? 1 - Math.pow(1 - t, 2) : 1;
        const x = Math.round(startX + (destX - startX) * ease);
        const y = Math.round(startY + (destY - startY) * ease);
        setWindow(BALL_SIZE, BALL_SIZE, x, y);
        if (step < steps) requestAnimationFrame(animate);
        else setWindow(BALL_SIZE, BALL_SIZE, destX, destY);
      }
      animate();
    }

    window.electronAPI.onToggleExpand(() => setExpanded(!isExpanded));
    function setExpanded(expanded) {
      isExpanded = expanded;
      if (expanded) {
        ball.style.display = 'none';
        widget.style.display = 'flex';
        let x = window.screenX, y = window.screenY;
        let { w, h } = getScreenBounds();
        let width = WIDGET_WIDTH;
        let height = widget.classList.contains('textarea-expanded') ? WIDGET_HEIGHT_EXPANDED : WIDGET_HEIGHT;
        if (x + width + SIDE_MARGIN > w)
          x = w - width - SIDE_MARGIN;
        if (y + height + BOTTOM_MARGIN > h)
          y = h - height - BOTTOM_MARGIN;
        setWindow(width, height, x, y);
        setTimeout(() => {
          noteInput.focus();
          noteInput.style.height = '28px';
        }, 150);
      } else {
        widget.style.display = 'none';
        ball.style.display = 'flex';
        animateToDefaultBallPosition();
      }
    }
    setExpanded(true);
  </script>
</body>
</html>
